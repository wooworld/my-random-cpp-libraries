<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <!-- Style sheet for document -->
    <style type="text/css">
      /* General container formatting */
      body
      {
        text-align:left;
        background-color:#6A7A9C;
        font-family:Arial, Helvetica, sans-serif;
        font-size:11pt;
        color:#FFFFFF;
      }      
      table
      {
        width:100%;
        caption-side:top;
      }
      a
      {
        color:#FFFFFF;
      }
      .rounded
      {
        -moz-border-radius:15px;
        -webkit-border-radius:15px;
        -khtml-border-radius:15px;
        border-radius:15px;
      }      
      .shadow
      {
        -moz-box-shadow: 4px 4px 4px #484848;
        -webkit-box-shadow: 4px 4px 4px #484848;
        box-shadow: 4px 4px 4px #484848;
      }
      
      /* Specific container formatting */
      .normalDiv
      {
        margin-left:auto;
        margin-right:auto;
        width:850px;
        text-align:left;
        background-color:#4476EB;
        padding:5px;
      }
      .headerDiv
      {
        height:70px;
        border:1px solid black;
        text-align:center;      
      }
      .headerTable
      {
        height:100%;
        width:100%;
        vertical-align:middle;
        text-align:center;
      }
      .bodyDiv
      {
        border:1px solid black;
        text-align:left;
      }
      .footerDiv
      {
        border:1px solid black;
        text-align:center;
      }
      .statusDiv
      {
        width:625px;
        padding:2px;
        border: 1px solid white;
        text-align:center;
      }
      .chartDiv
      {
        width:625px;
        height:325px;
        border:1px solid white;
        padding:0px;
      }
      .debugDiv
      {
        width:625px;
        height:325px;
        border:1px solid red;
        text-align:left;
        font-family:"Courier New", Courier, monospace;
        font-size:10pt;
        padding:0px;
      }
      .instructions
      {
        width:200px;
        vertical-align:top;
        text-align:left;
      }

      /* Font sizes, typefaces, and colors */
      .titleFont
      {
        font-family:Arial, Helvetica, sans-serif;
        font-size:22pt;
      }
      .footerFont
      {
        font-family:Arial, Helvetica, sans-serif;
        font-size:10pt;
      }
      .n
      {
        font-family:Arial, Helvetica, sans-serif;
        font-size:11pt;
      }
      h3
      {
        font-size:16pt;
        font-style:700;
        text-align:center;
      }   
      .sectionHeader
      {
        font-size:16pt;
        font-style:700;
        text-align:center;
      }
    </style>

    <title>CS6V81 Semantic Web Project</title>
  </head>

  <!-- Google Visualization API Map Include -->
  <script type="text/javascript" src="http://www.google.com/jsapi">
  </script>

  <!-- Google Visualization API Map Generator -->
  <script type="text/javascript">
    google.load( 'visualization', '1', {'packages': ['annotatedtimeline'] } );
    google.setOnLoadCallback( initializeMe );

    var query; // The query string for the data sets
    var _CPI_AREAS = 1;   
    var _CPI_ITEMS = 2;
    var _CPI_DATA  = 3;
    var datagovProxy = 'http://data-gov.tw.rpi.edu/sparql';
    
    var CPI_areas = new Object();
    var CPI_items = new Object();
    
    var CPI_seriesID = ''; // Currently displayed series
    
    var preData;      // Results of query
    var chart1;       // LineChart 1
    var chart1Data;   // Formatted, pretty data for LineChart 1
    var chart2;       // LineChart 2
    var chart2Data;   // Formatted, pretty data for LineChart 2

    function initializeMe()
    {
      CPI_getAreas();
      CPI_getItems();
    }
    
    function CPI_getAreas()
    {
      createQuery( _CPI_AREAS );      
      query.send( CPI_storeAreas );
    }
    
    function CPI_storeAreas( response )
    {
      if ( response.isError() )
      { 
        setStatusMessage( "Error in CPI area query: " + response.getMessage() + " " +
               response.getDetailedMessage()
             );
        return;
      }

      preData = response.getDataTable();
      if ( preData == null || preData.getNumberOfRows() == 0)
      {
        return;
      }
    
      var numRows = preData.getNumberOfRows();
    
      for ( var i = 0; i < numRows; i++ )
      {
        CPI_areas[preData.getValue(i, 0)] = preData.getValue(i, 1);
      }
      
      CPI_populateAreaSelect();
    }
    
    function CPI_populateAreaSelect()
    {
      var numRows = preData.getNumberOfRows()
      
      var areaList = document.cpi_area_form.cpi_area_select;
      areaList.options.length = 0;
      
      areaList.options[areaList.options.length] = new Option( "Select an area...", -1, false, false );
      
      for ( key in CPI_areas )
      {
        areaList.options[areaList.options.length] = new Option( CPI_areas[key], key, false, false );
      }
    }
    
    function CPI_getSelectedAreaText()
    {
      return document.cpi_area_form.cpi_area_select.options[document.cpi_area_form.cpi_area_select.selectedIndex].text;
    }
    
    function CPI_getSelectedAreaValue()
    {
      return document.cpi_area_form.cpi_area_select.options[document.cpi_area_form.cpi_area_select.selectedIndex].value;
    }

    function CPI_getItems()
    {
      createQuery( _CPI_ITEMS );      
      query.send( CPI_storeItems );
    }
    
    function CPI_storeItems( response )
    {
      if ( response.isError() )
      {
        setStatusMessage( "Error in CPI item query: " + response.getMessage() + " " +
               response.getDetailedMessage()
             );
        return;
      }

      preData = response.getDataTable();
      if ( preData == null || preData.getNumberOfRows() == 0 )
      {
        return;
      }
    
      var numRows = preData.getNumberOfRows();
    
      for ( var i = 0; i < numRows; i++ )
      {
        CPI_items[preData.getValue(i, 0)] = preData.getValue(i, 1);
      }
      
      CPI_populateItemSelect();
    }
    
    function CPI_populateItemSelect()
    {
      var numRows = preData.getNumberOfRows()
      
      var itemList = document.cpi_item_form.cpi_item_select;
      itemList.options.length = 0;
      
      itemList.options[itemList.options.length] = new Option( "Select an item...", -1, false, false );
      
      for ( key in CPI_items )
      {
        itemList.options[itemList.options.length] = new Option( CPI_items[key], key, false, false );
      }
    }
    
    function CPI_getSelectedItemText()
    {
      return document.cpi_item_form.cpi_item_select.options[document.cpi_item_form.cpi_item_select.selectedIndex].text;
    }
    
    function CPI_getSelectedItemValue()
    {
      return document.cpi_item_form.cpi_item_select.options[document.cpi_item_form.cpi_item_select.selectedIndex].value;
    }

    // Constructs the query object
    function createQuery( queryType )
    {
      if ( queryType == _CPI_AREAS )
      {
        query = new google.visualization.Query(
          datagovProxy + '?query-option=uri&output=gvds&query-uri=' +
          encodeURIComponent( 'http://dl.dropbox.com/u/47561249/cpi_areas.sparql' )
        );      
        query.setQuery('');
      }
      
      else if ( queryType == _CPI_ITEMS )
      {
        query = new google.visualization.Query(
          datagovProxy + '?query-option=uri&output=gvds&query-uri=' +
          encodeURIComponent( 'http://dl.dropbox.com/u/47561249/cpi_items.sparql' )
        );      
        query.setQuery('');
      }
      
      else if ( queryType == _CPI_DATA )
      {
        queryString = "PREFIX dgv316: <http://data-gov.tw.rpi.edu/vocab/p/316/> SELECT DISTINCT ?y ?m ?v WHERE { ?s dgv316:series_id \"" + CPI_seriesID + "\" . ?s dgv316:year ?y . ?s dgv316:period ?m . ?s dgv316:value ?v .} ORDER BY ASC(?y) ASC(?m)";
        
        addDebugMessage( queryString );
        
        query = new google.visualization.Query(
          datagovProxy + '?output=gvds&query=' + 
          encodeURIComponent( queryString )
        );
        query.setQuery('');
      }
      
      else
      {
        setStatusMessage( "Unexpected query type: " + queryType );
        return;
      }
    }
    
    function onChangeSelection()
    {
      // If the series ID constructed is not a valid ID, do nothing
      if ( CPI_constructSeriesID() == false )
      {
        setStatusMessage( "You need to select an area/region or an item still." );
        return;
      }
      
      setStatusMessage( "Updating the graphs." );
      
      createQuery( _CPI_DATA );
      query.send( CPI_updateVisualizations );
    }
    
    function CPI_constructSeriesID()
    {
      var surveyAbbrev = "CU";
      var seasonCode   = "U";
      var periodCode   = "R";    
      var areaCode = CPI_getSelectedAreaValue();
      var itemCode = CPI_getSelectedItemValue();
      
      while ( areaCode.length < 4 )
      {
        areaCode = "0" + areaCode;
      } 
      
      CPI_seriesID = surveyAbbrev + seasonCode + periodCode + areaCode + itemCode;
      
      if ( areaCode == -1 || itemCode == -1 || surveyAbbrev == -1 || seasonCode == -1 || periodCode == -1 )
      {
        return false;
      }     
      
      //addDebugMessage( CPI_seriesID );
      
      return true;
    }
    
    function CPI_updateVisualizations( response )
    {
      if ( response.isError() )
      {
        setStatusMessage( "Error in query for series: " + CPI_seriesID + ". " + 
              response.getMessage() + " " +
              response.getDetailedMessage()
             );
        return;
      }

      preData = response.getDataTable();
      if ( preData == null || preData.getNumberOfRows() == 0 )
      {
        setStatusMessage( "No results for this CPI area/region and item combination." );
        return;
      }
      
      chart1Data = new google.visualization.DataTable();
      chart1Data.addColumn( 'date', 'Date' );
      chart1Data.addColumn( 'number', 'CPI' );
      
      var vals = new Array();
      var numRows = preData.getNumberOfRows();
      
      //addDebugMessage( "numRows for data query = " + numRows );
      
      for ( var i = 0; i < numRows; i++ )
      {
        // FILTER OUT ITEMS THAT HAVE A DATE OF M13, S01-S03
        var month = preData.getValue(i, 1);
        var monthLetter = month.substring(0,1);
        if ( month == "M13" || monthLetter == "S" || monthLetter == "Q" )
        {
          continue;
        }
        
        else
        {        
          vals[0] = new Date( preData.getValue(i, 0), preData.getValue(i, 1).substring(1) , 1);
          vals[1] = preData.getValue(i, 2);
        }
        
        chart1Data.addRow( vals );
      }
      
      drawChart1();
    }
    
    function drawChart1()
    {
      var options = {};
      setChart1Title( "History of " + CPI_getSelectedItemText() );
      options['colors'] = new Array("#FF0000");
      options['displayDateBarSeparator'] = true;
      options['min'] = 95;
      
      chart1 = new google.visualization.AnnotatedTimeLine(
        document.getElementById( "chart1_canvas" ) );
        
      chart1.draw( chart1Data, options );
      
      setStatusMessage( "<i>Showing graph for:</i> " + CPI_getSelectedAreaText() + " =&gt; " + CPI_getSelectedItemText() );
    }
    
    function setStatusMessage( msg )
    {
      document.getElementById( 'status_canvas' ).innerHTML = msg;      
    }
    
    function setChart1Title( msg )
    {
      document.getElementById( 'chart1_title_canvas' ).innerHTML = msg;
    }
    
    function addDebugMessage( msg )
    {
      var debugMessage = document.getElementById( 'debug_canvas' ).innerHTML;      
      debugMessage = debugMessage + "<br />" + msg;
      document.getElementById( 'debug_canvas' ).innerHTML = debugMessage;
    }    
  </script>

  <body>
    <noscript>This page requires JavaScript be enabled to function properly. Enable JavaScript if you wish to use this page. </noscript>
    
    <!-- The header for the page -->
    <div class="normalDiv headerDiv shadow rounded">
      <table class="headerTable">
        <tr>
          <td style="vertical-align:middle">
            <font class="titleFont">Consumer Price Index, Import, and Export Prices</font>
          </td>
        </tr>
      </table>
    </div>
    <br />
    
    <!-- The main body component -->
    <div class="normalDiv bodyDiv shadow rounded">
      <table>
        <tr>
          <td class="instructions">
            <h3>Data Selection Instructions</h3>
            Click and change the selection of the dropdown boxes to change the data shown in the graphs.
            <a href="#details">See below for more information.</a>
            <div class="rounded" style="border:1px solid black;">
              <h3>CPI</h3>
              <form name="cpi_area_form" id="cpi_area_form">
                <center>
                  Select Area/Region:<br />
                  <select style="width:200px" name="cpi_area_select" id="cpi_area_select" onChange="onChangeSelection()">
                    <option>Loading area/region list...</option>
                  </select>
                </center>                
              </form>
              <form name="cpi_item_form" id="cpi_item_form">
                <center>
                  Select Item Category:<br />
                  <select style="width:200px" name="cpi_item_select" id="cpi_item_select" onChange="onChangeSelection()">
                    <option>Loading item list...</option>
                  </select>
                </center>
              </form>
            </div>
            <hr />
            
          </td>          
          <td>
            <div class="normalDiv statusDiv rounded" id="status_canvas">
              Select an area/region to the left and an item to view its historical price data.
            </div>
            <br />
            <div class="normalDiv statusDiv" id="chart1_title_canvas" style="width:625px;">
              Chart 1 Title
            </div>
            <div class="chartDiv" id="chart1_canvas" style="width:625px; height:325px">
              <center>Loading chart 1...</center>
            </div>
            <br />
            <div class="chartDiv" id="chart2_canvas" style="width:625px; height:325px">
              <center>Loading chart 2...</center>
            </div>
            <br />
            <div class="debugDiv" id="debug_canvas">
              &lt;No debug info...&gt;
            </div>
          </td>
        </tr>
      </table>
    </div>
    <br />
    
    <!-- Additional details, sources, and relevant data queries for the page -->
    <div class="normalDiv bodyDiv shadow rounded">
      <a name="details"><h3>Details</h3></a>
      <hr />
        Consumer Price Index (CPI) is the representative price of an item or collection of items.
        The graphs show the percent change in the price of the item over time. 
      <a name="sources"><h3>Sources</h3></a>
      <hr />
      Sources from data-gov, logd, google visualization, etc.
      <a name="relqueries"><h3>Relevant Queries</h3></a>
      <hr />
      Link to relevant queries/show relevant queries.
    </div>    
    <br />
    
    <!-- The footer for the page -->
    <div class="normalDiv footerDiv shadow rounded">
      <font class="footerFont">
        -Group Members-<br />
        Jeff Smith | Gary Steelman<br />
        CS6V81 - Semantic Web, 2011, Dr. Steven Seida
      </font>
    </div>

  </body>
</html>