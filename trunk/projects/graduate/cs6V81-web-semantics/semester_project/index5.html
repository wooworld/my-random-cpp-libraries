<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    
    <title>CS6V81 Semantic Web Project</title>
  </head>
  
  <!-- Google Maps API Key -->
  <script src="http://maps.google.com/maps?file=api&v=2&key=ABQIAAAAD0qlpMDIvnvezwed-ZL9tBQwH0hfZ_hMkwZkmTeIFGi2I_yWqxSTnxCDWeowfqGzTP5B2PQSHZI0zg" type="text/javascript">
  </script>
  
  <!-- Google Visualization API Map Include -->
  <script type="text/javascript" src="http://www.google.com/jsapi">
  </script>
  
  <!-- Google Visualization API Map Generator -->
  <script type="text/javascript">
    // Load the Google Visualization API with the map package
    google.load( 'visualization', '1', {'packages': ['corechart'] } );
    google.setOnLoadCallback( drawVisualization );
    
    var query;     // The query for the data sets
    var chart;     // The Google LineChart object
    var chartData; // The formatted table of data for the chart
    
    // Function called immediately after the visualization package loads
    function drawVisualization()
    {
      createQuery();
      
      // Execute the query and call formatChartData on the results when finished
      query.send( formatResults );
    }
    
    // Creates the query to the data sets
    function createQuery()
    {
      // SPARQL endpoint used to query the data sets
      var SPARQLProxy = 'http://data-gov.tw.rpi.edu/sparql';

      // SPARQL query location
      var SPARQLQueryLoc = 'http://dl.dropbox.com/u/47561249/query5.sparql';      

      var SPARQLQueryURL = SPARQLProxy +
                           '?query-option=uri&output=gvds&query-uri=' +
                           encodeURIComponent( SPARQLQueryLoc );
                           
      query = new google.visualization.Query( SPARQLQueryURL );
      query.setQuery('');
    }
    
    // Formats the data 
    function formatResults( response )
    {
      if ( response.isError() )
      {
        alert( "Error in query: " + response.getMessage() + " " +
               response.getDetailedMessage()
             );
        return;
      }

      var chartPreData = response.getDataTable();
      if ( chartPreData == null )
      {
        alert( "No results in query." );
        return;
      }
      
      var loc;
      var mag;
      var numRows = chartPreData.getNumberOfRows();
      var myMap = new Object(); // <location>, <frequency> map
      var vals = new Array();
      
      chartData = new google.visualization.DataTable();
      chartData.addColumn( 'string', 'loc' );
      chartData.addColumn( 'number', 'frequency' );
    
      // Initialize the map and count the number of earthquakes for each location
      for ( var i = 0; i < numRows; i++ )
      {
        loc = chartPreData.getValue( i, 0 );
        
        if ( typeof(myMap[loc]) == 'undefined' )
        {
          myMap[loc] = 0;
        }
        
        myMap[loc]++;
      }
    
      // Now put the names and counts into the actual chart data
      for ( key in myMap )
      {
        vals[0] = key;
        vals[1] = myMap[key];
        
        chartData.addRow( vals );
      }
      
      // This call must be made here or else it is out of scope and causes errors
      drawChart();
    }
    
    // Draws the chart to the web page
    function drawChart()
    {    
      chart = new google.visualization.LineChart(
        document.getElementById( 'chart_canvas' ) );
      
      //Customizing map
      var options = {};
      options['width'] = 1280;
      options['height'] = 720;
      options['title'] = 'Frequency of Earthquakes by Region';
      
      chart.draw( chartData, options );
    }    
  </script>
  
  <body>
    <center><h1>Frequency of Earthquakes by Region</h1></center>
    <div id="chart_canvas" style="width: 1280px; height: 720px">
      Loading...
    </div>
  </body>
</html>