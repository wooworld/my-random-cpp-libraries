<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    
    <title>CS6V81 Semantic Web Project</title>
  </head>
  
  <!-- Google Maps API Key -->
  <script src="http://maps.google.com/maps?file=api&v=2&key=ABQIAAAAD0qlpMDIvnvezwed-ZL9tBQwH0hfZ_hMkwZkmTeIFGi2I_yWqxSTnxCDWeowfqGzTP5B2PQSHZI0zg" type="text/javascript">
  </script>
  
  <!-- Google Visualization API Map Include -->
  <script type="text/javascript" src="http://www.google.com/jsapi">
  </script>
  
  <!-- Google Visualization API Map Generator -->
  <script type="text/javascript">
    // Load the Google Visualization API with the map package
    google.load( 'visualization', '1', {'packages': ['corechart', 'map'] } );
    google.setOnLoadCallback( drawVisualization );
    
    var query;     // The query for the data sets
    var map;       // The Google Map object
    var mapData;   // The formatted table of data for the map
    var chart;     // The Google LineChart object
    var chartData; // The formatted table of data for the chart
    
    // Function called immediately after the visualization package loads
    function drawVisualization()
    {
      createQuery();
      
      // Execute the query and call formatChartData on the results when finished
      query.send( formatResults );
    }
    
    // Creates the query to the data sets
    function createQuery()
    {
      // SPARQL endpoint used to query the data sets
      var SPARQLProxy = 'http://data-gov.tw.rpi.edu/sparql';

      // SPARQL query location, this is on my personal DropBox as a public file
      var SPARQLQueryLoc = 'http://dl.dropbox.com/u/47561249/query4.sparql';      

      var SPARQLQueryURL = SPARQLProxy +
                           '?query-option=uri&output=gvds&query-uri=' +
                           encodeURIComponent( SPARQLQueryLoc );
                           
      query = new google.visualization.Query( SPARQLQueryURL );
      query.setQuery('');
    }
    
    // Formats the data 
    function formatResults( response )
    {
      if ( response.isError() )
      {
        alert( "Error in query: " + response.getMessage() + " " +
               response.getDetailedMessage()
             );
        return;
      }

      var preData = response.getDataTable();
      if ( preData == null )
      {
        alert( "No results in query." );
        return;
      }
      
      formatChartData( preData );
      
      formatMapData( preData );  

      drawChart();
      
      drawMap();
    }
    
    // Format the raw data for the line chart
    function formatChartData( preData )
    {
      var loc;
      var mag;
      var numRows = preData.getNumberOfRows();
      var myMap = new Object(); // <location>, <frequency> map
      var vals = new Array();
      
      chartData = new google.visualization.DataTable();
      chartData.addColumn( 'string', 'loc' );
      chartData.addColumn( 'number', 'frequency' );
    
      // Initialize the map and count the number of earthquakes for each location
      for ( var i = 0; i < numRows; i++ )
      {
        loc = preData.getValue( i, 3 );
        
        if ( typeof(myMap[loc]) == 'undefined' )
        {
          myMap[loc] = 0;
        }
        
        myMap[loc]++;
      }
    
      // Now put the names and counts into the actual chart data
      for ( key in myMap )
      {
        vals[0] = key;
        vals[1] = myMap[key];
        
        chartData.addRow( vals );
      }
    }
    
    // Format the raw data for the map
    function formatMapData( preData )
    {
      var lat;
      var lon;
      var loc;
      var mag;
      var numRows = preData.getNumberOfRows();
      var vals = new Array(); // The row to be added to the mapData
      
      mapData = new google.visualization.DataTable();
      mapData.addColumn( 'number', 'lat' );
      mapData.addColumn( 'number', 'lon' );
      mapData.addColumn( 'string', 'loc' );
    
      for ( var i = 0; i < numRows; i++ )
      {
        lon = preData.getValue( i, 0 );
        lat = preData.getValue( i, 1 );
        mag = preData.getValue( i, 2 );
        loc = preData.getValue( i, 3 );
        
        vals[0] = lon;
        vals[1] = lat;
        vals[2] = mag + " @ " + loc;
        
        mapData.addRow( vals );
      }
    }
    
    // Draws the chart to the web page
    function drawChart()
    {    
      chart = new google.visualization.LineChart(
        document.getElementById( 'chart_canvas' ) );
      
      //Customizing chart
      var options = {};
      options['width'] = 800;
      options['height'] = 400;
      options['title'] = 'Frequency of Earthquakes by Region';
      
      chart.draw( chartData, options );
    }    
    
    // Draws the map to the web page
    function drawMap()
    {    
      map = new google.visualization.Map(
        document.getElementById( 'map_canvas' ) );
      
      //Customizing map
      var options = {};
      options['region'] = 'US';
      options['dataMode'] = 'regions';
      options['width'] = 800;
      options['height'] = 400;
      options['colors'] = [0xFFFFFF,0x00FF00,0x00CC00,0x00AA00,0x008800,0x006600];
      options['showTip'] = true;
      
      map.draw( mapData, options );
    }     
  </script>
  
  <body>
    <center><h1>Frequency of Earthquakes by Region</h1></center>
    <div id="map_canvas" style="width: 800px; height: 400px">
      Loading map...
    </div>
    <br />
    <div id="chart_canvas" style="width: 800px; height: 400px">
      Loading line chart...
    </div>
  </body>
</html>