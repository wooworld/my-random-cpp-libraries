<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    <!-- Style sheet for document -->
    <style type="text/css">
      /* General container formatting */
      body
      {
        text-align:left;
        background-color:#6A7A9C;
        font-family:Arial, Helvetica, sans-serif;
        font-size:11pt;
        color:#FFFFFF;
      }
      div
      {
        margin-left:auto;
        margin-right:auto;
        width:1000px;
        text-align:left;
        background-color:#4476EB;
        padding:5px;
      }
      table
      {
        width:100%;
        vertical-align:middle;
        /*border:1px solid black;
        border-collapse:collapse;*/
        frame:border;
        caption-side:top;
      }

      .rounded
      {
        -moz-border-radius:15px;
        -webkit-border-radius:15px;
        -khtml-border-radius:15px;
        border-radius:15px;
      }
      
      .shadow
      {
        -moz-box-shadow: 4px 4px 4px #484848;
        -webkit-box-shadow: 4px 4px 4px #484848;
        box-shadow: 4px 4px 4px #484848;
      }
      
      /* Specific container formatting */
      .headerDiv
      {
        height:100px;
        border:1px solid black;
        text-align:center;
        vertical-align:middle;        
      }
      .bodyDiv
      {
        border:1px solid black;
        text-align:left;
      }
      .footerDiv
      {
        border:1px solid black;
        text-align:center;
      }
      .mapDiv
      {
        width:90%;
        height:450px;
        border:1px solid white;
      }
      .chartDiv
      {
        width:90%;
        height:450px;
        border:1px solid white;
      }

      /* Font sizes, typefaces, and colors */
      .titleFont
      {
        font-family:Arial, Helvetica, sans-serif;
        font-size:22pt;
      }
      .footerFont
      {
        font-family:Arial, Helvetica, sans-serif;
        font-size:10pt;
      }
      .n
      {
        font-family:Arial, Helvetica, sans-serif;
        font-size:11pt;
      }
      caption
      {
        font-size:18pt;
        font-style:700;
      }
      
    </style>

    <title>CS6V81 Semantic Web Project</title>
  </head>

  <!-- Google Maps API Key -->
  <script type="text/javascript" src="http://maps.google.com/maps?file=api&v=2&key=ABQIAAAAD0qlpMDIvnvezwed-ZL9tBQwH0hfZ_hMkwZkmTeIFGi2I_yWqxSTnxCDWeowfqGzTP5B2PQSHZI0zg">
  </script>

  <!-- Google Visualization API Map Include -->
  <script type="text/javascript" src="http://www.google.com/jsapi">
  </script>

  <!-- Google Visualization API Map Generator -->
  <script type="text/javascript">
    // Load the Google Visualization API with the map package
    //google.load( 'visualization', '1', {'packages': ['corechart', 'map'] } );
    //google.setOnLoadCallback( drawVisualization );

    var query;     // The query for the data sets
    var filter = ''; // The filter for the query
    var map;       // The Google Map object
    var mapData;   // The formatted table of data for the map
    var chart;     // The Google LineChart object
    var chartData; // The formatted table of data for the chart
    var preData;   // The unformatted return of results from the query

    // Function called immediately after the visualization package loads
    function drawVisualization()
    {
      createQuery();

      // Execute the query and call formatChartData on the results when finished
      query.send( formatResults );
    }

    // Creates the query to the data sets
    function createQuery()
    {
      // SPARQL endpoint used to query the data sets
      var SPARQLProxy = 'http://data-gov.tw.rpi.edu/sparql';

      // SPARQL query to send
      var SPARQLQuery =
      'PREFIX dgp32: <http://data-gov.tw.rpi.edu/vocab/p/32/> SELECT  ?lat ?lon ?magnitude ?region WHERE { graph ?g{ ?s dgp32:magnitude ?magnitude ; dgp32:region ?region ; dgp32:lat ?lat ; dgp32:lon ?lon .';
      if ( filter != '' && filter != null )
      {
        SPARQLQuery += 'FILTER(regex(?region,\"' + filter + '\"))'
      }
      SPARQLQuery += ' } } LIMIT 1000';

      // The full URL for the query
      var SPARQLQueryURL = SPARQLProxy +
                           '?output=gvds&query=' +
                           encodeURIComponent( SPARQLQuery );

      query = new google.visualization.Query( SPARQLQueryURL );
      query.setQuery('');
    }

    // Formats the data
    function formatResults( response )
    {
      if ( response.isError() )
      {
        alert( "Error in query: " + response.getMessage() + " " +
               response.getDetailedMessage()
             );
        return;
      }

      preData = response.getDataTable();
      if ( preData == null )
      {
        alert( "No results in query." );
        return;
      }

      formatChartData();

      formatMapData();

      drawChart();

      drawMap();

      setOptions();
    }

    // Format the raw data for the line chart
    function formatChartData()
    {
      var loc;
      var mag;
      var numRows = preData.getNumberOfRows();
      var myMap = new Object(); // <location>, <frequency> map
      var vals = new Array();

      chartData = new google.visualization.DataTable();
      chartData.addColumn( 'string', 'loc' );
      chartData.addColumn( 'number', 'frequency' );

      // Initialize the map and count the number of earthquakes for each location
      for ( var i = 0; i < numRows; i++ )
      {
        loc = preData.getValue( i, 3 );

        if ( typeof(myMap[loc]) == 'undefined' )
        {
          myMap[loc] = 0;
        }

        myMap[loc]++;
      }

      // Now put the names and counts into the actual chart data
      for ( key in myMap )
      {
        vals[0] = key;
        vals[1] = myMap[key];

        chartData.addRow( vals );
      }
    }

    // Format the raw data for the map
    function formatMapData()
    {
      var lat;
      var lon;
      var loc;
      var mag;
      var numRows = preData.getNumberOfRows();
      var vals = new Array(); // The row to be added to the mapData

      mapData = new google.visualization.DataTable();
      mapData.addColumn( 'number', 'lat' );
      mapData.addColumn( 'number', 'lon' );
      mapData.addColumn( 'string', 'loc' );

      for ( var i = 0; i < numRows; i++ )
      {
        lon = preData.getValue( i, 0 );
        lat = preData.getValue( i, 1 );
        mag = preData.getValue( i, 2 );
        loc = preData.getValue( i, 3 );

        vals[0] = lon;
        vals[1] = lat;
        vals[2] = mag + " @ " + loc;

        mapData.addRow( vals );
      }
    }

    // Draws the chart to the web page
    function drawChart()
    {
      chart = new google.visualization.LineChart(
        document.getElementById( 'chart_canvas' ) );

      //Customizing chart
      var options = {};
      options['width'] = 800;
      options['height'] = 400;
      options['title'] = 'Frequency of Earthquakes by Region';

      chart.draw( chartData, options );
    }

    // Draws the map to the web page
    function drawMap()
    {
      map = new google.visualization.Map(
        document.getElementById( 'map_canvas' ) );

      //Customizing map
      var options = {};
      options['region'] = 'US';
      options['dataMode'] = 'regions';
      options['width'] = 800;
      options['height'] = 400;
      options['colors'] = [0xFFFFFF,0x00FF00,0x00CC00,0x00AA00,0x008800,0x006600];
      options['showTip'] = true;

      map.draw( mapData, options );
    }

    // Populates the dropdown boxes with options for the user to select.
    // The options are distinct so there aren't copies of Arkansas fifteen times.
    function setOptions()
    {
      var numRows = preData.getNumberOfRows();

      // The list of options from the dropdown boxes on the page
      var item1List = document.item1_form.item1_select;
      var item2List = document.item2_form.item2_select;

      // Clear the current list of options
      item1List.options.length = 0;
      item2List.options.length = 0;

      var loc;

      // Holds the names of earthquake locations
      var item1ListArray = new Array();

      // Only add an item to the array if it's not already in there.
      // Eliminates duplication.
      for ( var i = 0; i < numRows; i++ )
      {
        loc = preData.getValue( i, 3 );

        if ( typeof(item1ListArray[loc]) == 'undefined' )
        {
          // With our query, when we get back the data, we need to have the URI
          // for each item saved. We'll set that as the 0 here.
          // The key value "corn" will be displayed to the user, but the
          // URI to corn at data-gov/327#corn or whatever will be stored hidden
          // from them
          item1ListArray[loc] = loc;
        }
      }

      // Add an item to the end of item1List with <loc, index, not default, not selected>
      for ( key in item1ListArray )
      {
        item1List.options[item1List.options.length] = new Option( key, item1ListArray[key], false, false );
        item2List.options[item2List.options.length] = new Option( key, item1ListArray[key], false, false );
      }
    }

    // Updates the graph and other things when the user changes the selection
    // in the dropdown selections
    function onChangeItem( index )
    {
      var item1List = document.item1_form.item1_select;
      var item2List = document.item2_form.item2_select;

      filter = item1List.options[index].text;

      //alert( item1List.options[index].text + " " + item1List.options[index].value );

      createQuery();

      query.send( formatResults );
    }
  </script>

  <body>
    <!-- The header for the page -->
    <div class="headerDiv shadow rounded">
      <font class="titleFont">Consumer Price Index, Import, and Export Prices</font>
    </div>

    <br />
    
    <div class="bodyDiv shadow rounded">
      <!-- By putting these different items into table cells, we can use CSS to
      alter the style of the tables so they're more visually appealing -->
      <table>
        <caption>Data Selection</caption>
        <tr>
          <td colspan="2">
            <center><u>Select an item from each drop-down list to activate graphs</u></center>
          </td>
        </tr>
        <tr>
          <td style="width:50%">
            <form name="item1_form" id="item1_form">
              <br />
              <center><u>Item 1</u></center>
              <ul>
                <li>The full history of this item will be displayed on the first line graph.</li>
                <li>The history of this item will be compared as the x-axis to item 2 on the second line graph.</li>
              </ul>
              <center>
                Select item 1:<br />
                <select name="item1_select" id="item1_select" onChange="onChangeItem(this.selectedIndex)">
                  <option>Loading item 1 list...</option>
                </select>
              </center>                
            </form>
          </td>
          <td style="width:50%">
            <form name="item2_form" id="item2_form">
              <br />
              <center><u>Item 2</u></center>
              <ul>
                <li>The full history of this item will be displayed on the first line graph.</li>
                <li>The history of this item will be compared as the y-axis to item 1 on the second line graph.</li>
              </ul>
              <center>
                Select item 2:<br />
                <select name="item2_select" id="item2_select" onChange="onChangeItem(this.selectedIndex)">
                  <option>Loading item 2 list...</option>
                </select>
              </center>
            </form>
          </td>
        </tr>
      </table>

      <br />
      
      <table>
        <caption>Data Results (Frequency of Earthquakes by Region)</caption>
        <tr>
          <td>
            <div class="mapDiv" id="map_canvas">
              Loading map...
            </div>
          </td>
        </tr>
        <tr>
          <td>
            <div class="chartDiv" id="chart_canvas">
              Loading line chart...
            </div>
          </td>
        </tr>
      </table>

      <!--
      <div id="test_canvas" style="width: 800px; height: 400px">
        Test cavas...
      </div>
      -->
    </div>

    <br />
    
    <!-- The footer for the page -->
    <div class="footerDiv shadow rounded">
      <font class="footerFont">
        -Group Members-<br />
        Jeff Smith | Gary Steelman<br />
        CS6V81 - Semantic Web, 2011, Dr. Steven Seida
      </font>
    </div>

  </body>
</html>